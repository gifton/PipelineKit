name: CI (Multiplatform)

# This workflow adds macOS (SwiftPM), iOS Simulator, and watchOS Simulator coverage.
# Updated for macOS 26 / iOS 26 / Xcode 26.

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  CI: 'true'

jobs:
  macos-spm:
    name: macOS • SwiftPM (Debug + Release)
    runs-on: macos-26
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: System Info
        run: |
          echo "## System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Swift: $(swift --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Build (Debug)
        run: swift build -c debug

      - name: Test (Debug + Coverage)
        run: |
          echo "Starting test execution at $(date)"
          echo "Building tests..."
          swift build --build-tests

          # Create directory for profdata files
          mkdir -p .build/debug/codecov

          # Run each test target individually to prevent one hung test from blocking all tests
          set +e  # Don't exit on test failure

          TEST_TARGETS=(
            "PipelineKitTests"
            "PipelineKitCoreTests"
            "PipelineKitResilienceTests"
            "PipelineKitSecurityTests"
            "PipelineKitCacheTests"
            "PipelineKitPoolingTests"
            "PipelineKitObservabilityTests"
          )

          OVERALL_EXIT_CODE=0

          for target in "${TEST_TARGETS[@]}"; do
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Running $target with coverage..."
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Start time: $(date)"

            swift test --filter "$target" --enable-code-coverage || TARGET_EXIT_CODE=$?

            TARGET_EXIT_CODE=${TARGET_EXIT_CODE:-0}
            echo "End time: $(date) (exit code: $TARGET_EXIT_CODE)"

            if [ $TARGET_EXIT_CODE -eq 0 ]; then
              echo "✅ $target passed"
              # Preserve profdata
              if [ -f .build/debug/codecov/default.profdata ]; then
                cp .build/debug/codecov/default.profdata .build/debug/codecov/${target}.profdata
                echo "   Saved coverage data to ${target}.profdata"
              fi
            else
              echo "::warning::❌ $target failed with exit code $TARGET_EXIT_CODE"
              OVERALL_EXIT_CODE=1
            fi
          done

          set -e
          echo "Tests completed at $(date)"
          exit $OVERALL_EXIT_CODE

      - name: Build (Release)
        run: swift build -c release

      - name: Export coverage
        run: |
          set -euo pipefail

          # Find test binary and profdata
          BIN=$(find .build -name "*PackageTests.xctest" -type d | head -n1)/Contents/MacOS/$(basename $(find .build -name "*PackageTests.xctest" -type d | head -n1) .xctest)
          PROF=$(find .build -name default.profdata | head -n1)

          if [[ -f "$BIN" && -f "$PROF" ]]; then
            echo "Found test binary: $BIN"
            echo "Found profdata: $PROF"

            LLVM_COV=$(xcrun --find llvm-cov)

            echo "Using llvm-cov: $LLVM_COV"
            $LLVM_COV --version || true

            $LLVM_COV export "$BIN" -instr-profile="$PROF" -format=lcov > coverage.lcov || {
              echo "::warning::Failed to export coverage - format mismatch or corrupt profdata"
              exit 0
            }

            echo "✅ Coverage exported successfully"
          else
            echo "::warning::Missing test binary or profdata file"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-macos
          path: coverage.lcov
          if-no-files-found: ignore

  ios-sim:
    name: iOS 26 • Simulator Tests
    runs-on: macos-26
    timeout-minutes: 25
    env:
      SCHEME: PipelineKit-Package
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: System Info
        run: |
          echo "## System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
          echo "- Available iOS 26+ simulators:" >> $GITHUB_STEP_SUMMARY
          xcrun simctl list devices available | grep -i iphone | grep "26\." | head -5 >> $GITHUB_STEP_SUMMARY || echo "  (listing may be empty)" >> $GITHUB_STEP_SUMMARY

      - name: Find iOS Simulator
        id: find-sim
        run: |
          # Find the latest iOS 26.x iPhone simulator
          DEVICE=$(xcrun simctl list devices available -j | \
            jq -r '.devices | to_entries[] | select(.key | contains("iOS") and contains("26")) | .value[] | select(.name | contains("iPhone")) | .name' | \
            head -1)

          if [ -z "$DEVICE" ]; then
            echo "No iOS 26.x iPhone simulator found, falling back to generic destination"
            echo "destination=platform=iOS Simulator,name=Any iOS Simulator Device" >> $GITHUB_OUTPUT
          else
            echo "Found simulator: $DEVICE"
            echo "destination=platform=iOS Simulator,name=$DEVICE" >> $GITHUB_OUTPUT
          fi

      - name: Build for testing (Debug)
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme "$SCHEME" \
            -destination "${{ steps.find-sim.outputs.destination }}" \
            -configuration Debug \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            build-for-testing | xcpretty || exit ${PIPESTATUS[0]}

      - name: Run tests (Debug)
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme "$SCHEME" \
            -destination "${{ steps.find-sim.outputs.destination }}" \
            -configuration Debug \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            test | xcpretty || exit ${PIPESTATUS[0]}

  watchos-sim:
    name: watchOS 26 • Simulator Build
    runs-on: macos-26
    timeout-minutes: 20
    continue-on-error: true  # keep advisory while we stabilize
    env:
      SCHEME: PipelineKit-Package
      DESTINATION: generic/platform=watchOS Simulator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Xcode version
        run: xcodebuild -version

      - name: Build (Debug)
        run: |
          set -euo pipefail
          xcodebuild \
            -scheme "$SCHEME" \
            -destination "$DESTINATION" \
            -configuration Debug \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            build | xcpretty || exit ${PIPESTATUS[0]}
