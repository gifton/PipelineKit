name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *'  # Run at 2 AM UTC daily
  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  CI: 'true'

permissions:
  contents: read
  checks: write

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel nightly builds

jobs:
  nightly-test:
    name: Nightly Test Suite
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: System Info
        run: |
          echo "## System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Swift: $(swift --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Full Test Suite
        run: |
          swift test --enable-code-coverage

      - name: Stress Tests
        run: |
          # Run tests multiple times to catch flaky tests
          for i in {1..3}; do
            echo "ðŸ”„ Test iteration $i/3"
            swift test --configuration release
          done
        timeout-minutes: 30

  linux-test:
    name: Linux Test
    runs-on: ubuntu-latest
    container: swift:6.2
    timeout-minutes: 30
    continue-on-error: true  # Linux is secondary platform

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          apt-get update && apt-get install -y \
            libssl-dev \
            libcurl4-openssl-dev \
            libxml2-dev \
            tzdata \
            git

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.swiftpm
          key: linux-swift-6.2-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            linux-swift-6.2-

      - name: Build
        run: swift build

      - name: Test
        run: swift test

  memory-test:
    name: Memory & Leak Tests
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build with Address Sanitizer
        run: swift build --sanitize=address

      - name: Run Tests with Address Sanitizer
        run: swift test --sanitize=address
        continue-on-error: true  # Don't fail for now

      - name: Build with Thread Sanitizer
        run: swift build --sanitize=thread

      - name: Run Tests with Thread Sanitizer
        run: swift test --sanitize=thread
        continue-on-error: true  # Don't fail for now

  extended-benchmarks:
    name: Extended Benchmarks
    runs-on: macos-26
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build Performance Tests
        run: swift build --configuration release --target PipelineKitPerformanceTests

      - name: Run Extended Performance Tests
        run: |
          # Run full performance test suite
          swift test --configuration release --filter "PipelineKitPerformanceTests" || {
            EXIT_CODE=$?
            echo "Performance tests completed with status: $EXIT_CODE"
          }

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-benchmark-results
          path: |
            benchmark-results/
            .benchmarkBaselines/
          if-no-files-found: ignore
          retention-days: 30

  report:
    name: Nightly Report
    runs-on: ubuntu-latest
    needs: [nightly-test, linux-test, memory-test, extended-benchmarks]
    if: always()

    steps:
      - name: Generate Report
        run: |
          echo "# Nightly Build Report" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Nightly Tests: ${{ needs.nightly-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: ${{ needs.linux-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Memory Tests: ${{ needs.memory-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Benchmarks: ${{ needs.extended-benchmarks.result }}" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.nightly-test.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Nightly build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Nightly build passed" >> $GITHUB_STEP_SUMMARY
          fi
