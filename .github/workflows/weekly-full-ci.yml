name: Weekly Full CI

on:
  schedule:
    - cron: '0 3 * * 0'  # Run at 3 AM UTC every Sunday
  workflow_dispatch:
    inputs:
      skip_paths_filter:
        description: 'Run full CI regardless of changed files'
        type: boolean
        default: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  CI: 'true'
  # Full CI always enforces quality gates
  ENFORCE_SWIFTLINT: 'true'
  ENFORCE_COVERAGE: 'true'
  ENFORCE_PERFORMANCE: 'true'
  MINIMUM_COVERAGE: 70

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  # Run ALL tests on macOS 26
  full-test-macos:
    name: Full Test (macOS 26)
    runs-on: macos-26
    timeout-minutes: 45

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: System Info
      run: |
        echo "## System Info" >> $GITHUB_STEP_SUMMARY
        echo "- Swift: $(swift --version | head -1)" >> $GITHUB_STEP_SUMMARY
        echo "- Xcode: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
        echo "- macOS: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY

    - name: Cache SPM
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-weekly-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-weekly-
          ${{ runner.os }}-spm-

    - name: Build All Targets
      run: |
        swift build --build-tests
        swift build --configuration release

    - name: Run All Tests
      run: |
        swift test --enable-code-coverage

    - name: Run Performance Tests
      run: |
        swift test --configuration release --filter "PipelineKitPerformanceTests"

  # Linux test
  full-test-linux:
    name: Full Test (Linux)
    runs-on: ubuntu-latest
    container: swift:6.2
    timeout-minutes: 45
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        apt-get update && apt-get install -y \
          libssl-dev \
          libcurl4-openssl-dev \
          libxml2-dev \
          tzdata \
          git

    - name: Build All Targets
      run: |
        swift build --build-tests
        swift build --configuration release

    - name: Run All Tests
      run: |
        swift test

  # Deep security scan
  security-audit:
    name: Deep Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy Deep Scan
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: 'fs'
        scan-ref: '.'
        severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
        format: 'sarif'
        output: 'trivy-results.sarif'
        args: --config .trivy.yaml

    - name: Upload Security Results
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Dependency Audit
      run: |
        echo "Dependency tree generated - check for outdated dependencies"

  # Comprehensive benchmarking
  benchmark-suite:
    name: Full Benchmark Suite
    runs-on: macos-26
    timeout-minutes: 90

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Cache SPM
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-benchmark-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-benchmark-
          ${{ runner.os }}-spm-

    - name: Run Extended Benchmarks
      run: |
        swift build --configuration release --build-tests

        # Run performance tests multiple times for consistency
        for i in {1..3}; do
          echo "Benchmark iteration $i/3"
          swift test --configuration release --filter "PerformanceTests"
        done

    - name: Memory Profiling
      run: |
        swift test --sanitize=address || echo "Address sanitizer completed"
        swift test --sanitize=thread || echo "Thread sanitizer completed"

  # Documentation completeness check
  documentation-audit:
    name: Documentation Audit
    runs-on: macos-26
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Check Documentation Coverage
      run: |
        swift package generate-documentation \
          --target PipelineKit \
          --output-path ./docs \
          --disable-indexing \
          --transform-for-static-hosting \
          --analyze \
          --level detailed

    - name: Upload Documentation Report
      uses: actions/upload-artifact@v4
      with:
        name: documentation-audit
        path: docs/
        retention-days: 7

  # Compatibility testing
  compatibility-check:
    name: Compatibility Check
    runs-on: macos-26
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'

    - name: Test Package Resolution
      run: |
        mkdir test-integration
        cd test-integration

        swift package init --type executable

        # Add PipelineKit as dependency
        cat > Package.swift << EOF
        // swift-tools-version:6.2
        import PackageDescription

        let package = Package(
            name: "TestIntegration",
            platforms: [.macOS(.v26)],
            dependencies: [
                .package(path: "..")
            ],
            targets: [
                .executableTarget(
                    name: "TestIntegration",
                    dependencies: ["PipelineKit"])
            ]
        )
        EOF

        swift build

  # Weekly report
  weekly-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    needs: [full-test-macos, full-test-linux, security-audit, benchmark-suite, documentation-audit, compatibility-check]
    if: always()
    timeout-minutes: 10

    steps:
    - name: Generate Report
      run: |
        echo "# Weekly Full CI Report" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results:" >> $GITHUB_STEP_SUMMARY
        echo "- macOS Tests: ${{ needs.full-test-macos.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Linux Tests: ${{ needs.full-test-linux.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Benchmark Suite: ${{ needs.benchmark-suite.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation Audit: ${{ needs.documentation-audit.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibility Check: ${{ needs.compatibility-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.full-test-macos.result }}" = "success" ] && \
           [ "${{ needs.security-audit.result }}" = "success" ] && \
           [ "${{ needs.benchmark-suite.result }}" = "success" ]; then
          echo "## Overall Status: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "## Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Action Required:" >> $GITHUB_STEP_SUMMARY
          echo "Please review failing jobs and address issues before next release." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Create Issue for Failures
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Weekly CI Failed - ${date}`,
            body: `The weekly full CI run has failed. Please review the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
            labels: ['ci', 'weekly-audit']
          });
